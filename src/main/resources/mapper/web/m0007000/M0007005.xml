<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dowinsys.mes.web.m0007000.mapper.M0007005Mapper">
    <select id="M0007005_Sch1" parameterType="Map" resultType="CamelMap">
        select *
        from d04_카세트마스터
        where 1=1
        <if test="step != null and step != ''">
            and upper(종류) like CONCAT('%',upper(#{step}),'%')
        </if>
        <if test="type != null and type != ''">
            and upper(타입) like CONCAT('%',upper(#{type}),'%')
        </if>
        <if test="model != null and model != ''">
            and upper(모델) like CONCAT('%',upper(#{model}),'%')
        </if>
        <if test="cstNo != null and cstNo != ''">
            and upper(CST_NO) like CONCAT('%',upper(#{cstNo}),'%')
        </if>
        <if test="status != null and status != ''">
            and upper(카세트상태) like CONCAT('%',upper(#{status}),'%')
        </if>
        <if test="statusValue != null and statusValue != ''">
            and upper(카세트상태값) = upper(#{statusValue})
        </if>
        order by 공장코드,종류,타입,모델,CST_NO,열,행,위치,카세트상태,카세트상태값
    </select>

    <select id="M0007005_Sch2" parameterType="Map" resultType="CamelMap">
        select A.*, B.설비약명, C.공정명
        from (
            select *
            from d04_카세트HISTORY
            where 1=1
            <if test="step != null and step != ''">
                and upper(종류) like CONCAT('%',upper(#{step}),'%')
            </if>
            <if test="type != null and type != ''">
                and upper(타입) like CONCAT('%',upper(#{type}),'%')
            </if>
            <if test="model != null and model != ''">
                and upper(모델) like CONCAT('%',upper(#{model}),'%')
            </if>
            <if test="cstNo != null and cstNo != ''">
                and upper(CST_NO) like CONCAT('%',upper(#{cstNo}),'%')
            </if>
            <if test="status != null and status != ''">
                and upper(카세트상태) like CONCAT('%',upper(#{status}),'%')
            </if>
            <if test="statusValue != null and statusValue != ''">
                and upper(카세트상태값) = upper(#{statusValue})
            </if>
            <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
                and (시작일자 between #{startDate} and #{endDate})
            </if>
        ) A
        left join (select 설비약명, 설비번호 from dw_기타설비 where 설비구분 = '카세트세척') B
        on A.설비코드 = B.설비번호
        left join (select distinct 공정코드, 공정명 from dw_process_plan) C
        on A.공정코드 = C.공정코드
        order by 시작일자,시작시간,공장코드,종류,타입,모델,CST_NO,위치,카세트상태,카세트상태값
    </select>

    <select id="M0007005_Sch3" parameterType="Map" resultType="CamelMap">
        select 공장코드,종류,타입,모델,CST_NO,위치,카세트상태,카세트상태값,시작일자,시작시간,종료일자,종료시간,점검자,점검결과
        , json_value(점검항목, '$."세정_외관"') as 세정_외관
        , json_value(점검항목, '$."세정_Bar위치"') as 세정_Bar위치
        , json_value(점검항목, '$."세정_평탄도_바닥과_CST"') as 세정_평탄도_바닥과_CST
        , json_value(점검항목, '$."세정_평탄도_앞면_옆면"') as 세정_평탄도_앞면_옆면
        , json_value(점검항목, '$."세정_평탄도_뒷면_옆면"') as 세정_평탄도_뒷면_옆면
        , json_value(점검항목, '$."강화_브라켓_지그일치유무"') as 강화_브라켓_지그일치유무
        , json_value(점검항목, '$."강화_슬롯상태"') as 강화_슬롯상태
        , json_value(점검항목, '$."강화_MESH올상태"') as 강화_MESH올상태
        , json_value(점검항목, '$."강화_Mesh들뜸"') as 강화_Mesh들뜸
        , json_value(점검항목, '$."강화_볼트체결"') as 강화_볼트체결
        , json_value(점검항목, '$."강화_외관"') as 강화_외관
        , 비고
        from d04_카세트점검이력
        where 1=1
        <if test="step != null and step != ''">
            and upper(종류) like CONCAT('%',upper(#{step}),'%')
        </if>
        <if test="type != null and type != ''">
            and upper(타입) like CONCAT('%',upper(#{type}),'%')
        </if>
        <if test="model != null and model != ''">
            and upper(모델) like CONCAT('%',upper(#{model}),'%')
        </if>
        <if test="cstNo != null and cstNo != ''">
            and upper(CST_NO) like CONCAT('%',upper(#{cstNo}),'%')
        </if>
        <if test="status != null and status != ''">
            and upper(카세트상태) like CONCAT('%',upper(#{status}),'%')
        </if>
        <if test="statusValue != null and statusValue != ''">
            and upper(카세트상태값) = upper(#{statusValue})
        </if>
        <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
            and (시작일자 between #{startDate} and #{endDate})
        </if>
        order by 시작일자,시작시간,공장코드,종류,타입,모델,CST_NO,위치,카세트상태,카세트상태값,점검자,점검결과
    </select>

    <select id="M0007005_Sch4" parameterType="Map" resultType="CamelMap">
        select A.*, B.설비약명, C.공정명
        from (
            select *
            from d04_카세트HISTORY
            where 1=1
            <if test="step != null and step != ''">
                and upper(종류) like CONCAT('%',upper(#{step}),'%')
            </if>
            <if test="type != null and type != ''">
                and upper(타입) like CONCAT('%',upper(#{type}),'%')
            </if>
            <if test="model != null and model != ''">
                and upper(모델) like CONCAT('%',upper(#{model}),'%')
            </if>
            <if test="cstNo != null and cstNo != ''">
                and upper(CST_NO) like CONCAT('%',upper(#{cstNo}),'%')
            </if>
            <if test="status != null and status != ''">
                and upper(카세트상태) like CONCAT('%',upper(#{status}),'%')
            </if>
            <if test="statusValue != null and statusValue != ''">
                and upper(카세트상태값) = upper(#{statusValue})
            </if>
            <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
                and (시작일자 between #{startDate} and #{endDate})
            </if>
            and (설비코드 in (select 설비번호 설비코드 from dw_기타설비  where 설비구분 = '카세트세척'))
        ) A
        left join (select 설비약명, 설비번호 from dw_기타설비 where 설비구분 = '카세트세척') B
        on A.설비코드 = B.설비번호
        left join (select distinct 공정코드, 공정명 from dw_process_plan) C
        on A.공정코드 = C.공정코드
        order by 시작일자,시작시간,공장코드,종류,타입,모델,CST_NO,위치,카세트상태,카세트상태값
    </select>

    <update id="M0007005_Update1" parameterType="Map">
        update d04_카세트마스터
        set 열 = #{열}
        ,행 = #{행}
        ,위치 = #{위치}
        ,카세트상태 = #{카세트상태}
        ,카세트상태값 = #{카세트상태값}
        ,반입일자 = #{반입일자}
        ,반입시간 = #{반입시간}
        ,반입자 = #{반입자}
        ,최근세척시작일 = #{최근세척시작일}
        ,최근세척시작시간 = #{최근세척시작시간}
        ,최근세척종료일 = #{최근세척종료일}
        ,최근세척종료시간 = #{최근세척종료시간}
        ,세척작업자 = #{세척작업자}
        ,반출일 = #{반출일}
        ,반출시간 = #{반출시간}
        ,반출부서 = #{반출부서}
        ,반출자 = #{반출자}
        ,반출사유 = #{반출사유}
        ,회수일 = #{회수일}
        ,회수시간 = #{회수시간}
        ,회수자부서 = #{회수자부서}
        ,회수자 = #{회수자}
        ,최근점검시작일 = #{최근점검시작일}
        ,최근점검시작시간 = #{최근점검시작시간}
        ,최근점검종료일 = #{최근점검종료일}
        ,최근점검종료시간 = #{최근점검종료시간}
        ,점검작업자 = #{점검작업자}
        ,점검결과 = #{점검결과}
        ,비고 = #{비고}
        WHERE 1=1
        and 공장코드 = #{공장코드}
        and 종류 = #{종류}
        and 타입 = #{타입}
        and 모델 = #{모델}
        and CST_NO = #{cstNo};

        insert into d04_카세트HISTORY
        (공장코드, 종류, 타입, 모델, CST_NO, 위치, 카세트상태, 카세트상태값, 시작일자, 시작시간, 종료일자, 종료시간, 담당자, 비고)
        select 공장코드, 종류, 타입, 모델, CST_NO, 위치, 카세트상태, 카세트상태값,
        convert(varchar(8), GETDATE(), 112) 시작일자,
        replace(convert(varchar(8), GETDATE(), 108),':','') 시작시간,
        convert(varchar(8), GETDATE(), 112) 종료일자,
        replace(convert(varchar(8), GETDATE(), 108),':','') 종료시간,
        COALESCE(반입자,세척작업자,반출자,회수자,점검작업자) 담당자,
        '카세트마스터수정' 비고
        from d04_카세트마스터
        where 1 = 1
        and 공장코드 = #{공장코드}
        and 종류 = #{종류}
        and 타입 = #{타입}
        and 모델 = #{모델}
        and CST_NO = #{cstNo};
    </update>

    <insert id="uploadExcel" parameterType="Map">
        INSERT INTO d04_카세트마스터
        (
        공장코드
        ,종류
        ,타입
        ,모델
        ,CST_NO
        ,열
        ,행
        ,위치
        ,카세트상태
        ,카세트상태값
        ,반입일자
        ,반입시간
        ,반입자
        ,최근세척시작일
        ,최근세척시작시간
        ,최근세척종료일
        ,최근세척종료시간
        ,세척작업자
        ,반출일
        ,반출시간
        ,반출부서
        ,반출자
        ,반출사유
        ,회수일
        ,회수시간
        ,회수자부서
        ,회수자
        ,최근점검시작일
        ,최근점검시작시간
        ,최근점검종료일
        ,최근점검종료시간
        ,점검작업자
        ,점검결과
        ,비고
        )
        VALUES
        (
        #{공장코드}
        ,#{종류}
        ,#{타입}
        ,#{모델}
        ,#{cstNo}
        ,#{열}
        ,#{행}
        ,#{위치}
        ,#{카세트상태}
        ,#{카세트상태값}
        ,#{반입일자}
        ,#{반입시간}
        ,#{반입자}
        ,#{최근세척시작일}
        ,#{최근세척시작시간}
        ,#{최근세척종료일}
        ,#{최근세척종료시간}
        ,#{세척작업자}
        ,#{반출일}
        ,#{반출시간}
        ,#{반출부서}
        ,#{반출자}
        ,#{반출사유}
        ,#{회수일}
        ,#{회수시간}
        ,#{회수자부서}
        ,#{회수자}
        ,#{최근점검시작일}
        ,#{최근점검시작시간}
        ,#{최근점검종료일}
        ,#{최근점검종료시간}
        ,#{점검작업자}
        ,#{점검결과}
        ,#{비고}
        )
    </insert>

    <update id="uploadExcelUpdate" parameterType="Map">
        update d04_카세트마스터
        set 열 = #{열}
        ,행 = #{행}
        ,위치 = #{위치}
        ,카세트상태 = #{카세트상태}
        ,카세트상태값 = #{카세트상태값}
        ,반입일자 = #{반입일자}
        ,반입시간 = #{반입시간}
        ,반입자 = #{반입자}
        ,최근세척시작일 = #{최근세척시작일}
        ,최근세척시작시간 = #{최근세척시작시간}
        ,최근세척종료일 = #{최근세척종료일}
        ,최근세척종료시간 = #{최근세척종료시간}
        ,세척작업자 = #{세척작업자}
        ,반출일 = #{반출일}
        ,반출시간 = #{반출시간}
        ,반출부서 = #{반출부서}
        ,반출자 = #{반출자}
        ,반출사유 = #{반출사유}
        ,회수일 = #{회수일}
        ,회수시간 = #{회수시간}
        ,회수자부서 = #{회수자부서}
        ,회수자 = #{회수자}
        ,최근점검시작일 = #{최근점검시작일}
        ,최근점검시작시간 = #{최근점검시작시간}
        ,최근점검종료일 = #{최근점검종료일}
        ,최근점검종료시간 = #{최근점검종료시간}
        ,점검작업자 = #{점검작업자}
        ,점검결과 = #{점검결과}
        ,비고 = #{비고}
        WHERE 1=1
        and 공장코드 = #{공장코드}
        and 종류 = #{종류}
        and 타입 = #{타입}
        and 모델 = #{모델}
        and CST_NO = #{cstNo}
    </update>

    <select id="searchCstNo" parameterType="Map" resultType="CamelMap">
        select *
        from d04_카세트마스터
        where 1=1
        <if test="cstNo != null and cstNo != ''">
            and upper(CST_NO) = upper(#{cstNo})
        </if>
    </select>

    <select id="execSaveCstChangeList" resultType="CamelMap">
        EXEC dbo.Cassette마스터상태변경
        @작업자 = #{worker},
        @작업상태 = #{status},
        @cst_list = #{cstList};

        select CST_NO, 카세트상태
        from d04_카세트마스터
        where 1=1
        AND CST_NO IN (
        SELECT TRIM(value) AS cst_list
        FROM STRING_SPLIT(#{cstList}, ';')
        WHERE value != ''
        );
    </select>
</mapper>